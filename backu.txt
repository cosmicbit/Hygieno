const waste  = require('../../SchemaModels/wasteRequests')

module.exports.handleWasteRequest = async ( data ) => {

    const responseData = ( condition , error ) => {
        return new Promise( (resolve , reject ) => {
            if(condition)
            {
                resolve({
                    wasteStatus : 200,
                    message : "The Waste request have been successfully stored."
                })
            }
            else
            {
                reject()
            }
    })
}

    const {location} = data;
    const { type , coordinates } = JSON.parse(location);
    const imageBuffer = Buffer.from(data.waste_image, 'base64');
    const newWaste = new waste({
        userId: data.userId,
    
        wasteTypes: data.wasteTypes,
    
        image: imageBuffer,
    
        location:{
            type : type,
            coordinates : coordinates
        }
    })
            await newWaste.save().then( (data) => {
                console.log("The Waste request have been successfully stored.");
                return new Promise.resolve({
                    wasteStatus : 200,
                    message : "The Waste request have been successfully stored."
                })
        }).catch((error)=>{
            console.log("Error storing waste requests");
            console.log(error);
            return new Promise.reject({
                wasteStatus : 404,
                message : `Error storing wastes because ${error}`
            })
        })
}

//
const express = require('express');
const multer = require('multer');
const router = express.Router();
const {handleWasteRequest} = require('../Controllers/wasteManagement/handleWasteRequest');

const upload = multer({ storage: multer.memoryStorage()});

router.post('/wasteRequests',upload.single('waste_image') ,async (req,res) => {
    try{
        console.log("Received Waste Store request");
        await handleWasteRequest(req.body).then((response)=>{
            console.log("Response = " + response);
            if( response.status === 200 )
                res.send({
                    status:200,
                    message:"Your Waste request have been successfully added"
            })
            else
            res.send({
                status:400,
                message:`Error adding waste ${response.error}`
            })
        }).catch( (error) => res.send(error))
    }
    catch(error){
        res.send(error.message);
        console.log("Error "+error.message);
    }   
})

module.exports = router;